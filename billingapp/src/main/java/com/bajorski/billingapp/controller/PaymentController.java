package com.bajorski.billingapp.controller;import com.bajorski.billingapp.io.OrderRequest;import com.bajorski.billingapp.service.OrderService;import com.bajorski.billingapp.service.StripeService;import com.stripe.exception.StripeException;import com.stripe.model.Event;import com.stripe.model.checkout.Session;import com.stripe.net.Webhook;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Value;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.web.bind.annotation.*;import java.util.Map;@RestController@RequestMapping("/payments")@RequiredArgsConstructor@Slf4jpublic class PaymentController {    private final StripeService stripeService;    private final OrderService orderService;    @Value("${stripe.webhook.secret}")    private String stripeWebhookSecret;    @PostMapping("/create-checkout-session")    public ResponseEntity<Map<String, String>> createCheckoutSession(@RequestBody OrderRequest request) {        log.info("Creating Stripe Checkout session for order: {}", request.getOrderId());        try {            String sessionUrl = stripeService.createCheckoutSession(request, request.getOrderId());            return ResponseEntity.ok(Map.of("url", sessionUrl));        } catch (StripeException e) {            log.error("Error creating Stripe session", e);            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();        }    }    @PostMapping("/stripe-webhook")    public ResponseEntity<String> handleStripeWebhook(@RequestBody String payload, @RequestHeader("Stripe-Signature") String sigHeader) {        log.info("Received Stripe webhook...");        Event event;        try {            event = Webhook.constructEvent(payload, sigHeader, stripeWebhookSecret);        } catch (Exception e) {            log.warn("Webhook signature verification failed.", e);            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Signature verification failed");        }        switch (event.getType()) {            case "checkout.session.completed":                Session session = (Session) event.getData().getObject();                log.info("Payment for checkout session {} succeeded.", session.getId());                String orderId = session.getClientReferenceId();                String paymentIntentId = session.getPaymentIntent();                orderService.fulfillOrder(orderId, paymentIntentId);                break;            default:                log.warn("Unhandled event type: {}", event.getType());        }        return ResponseEntity.ok("Received");    }}